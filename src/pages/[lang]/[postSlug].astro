---
// Styles
import "@styles/components/_blocks.scss";
import "@styles/plugins/shiki.scss";

// Components
import BlogPost from "@layouts/BlogPost.astro";
import { getAllPostsWithSlugs, getPostBySlug } from "@services/api";
import type { CoreHeadingBlock } from "@ts_types/generated/graphql";
import ListBlock from "@components/content-blocks/ListBlock.vue";
import ButtonsBlock from "@components/content-blocks/ButtonsBlock.vue";
import FigureBlock from "@components/content-blocks/FigureBlock.vue";
import HeadlineBlock from "@components/content-blocks/HeadlineBlock.vue";
import ParagraphBlock from "@components/content-blocks/ParagraphBlock.vue";
import DetailsBlock from "@components/content-blocks/DetailsBlock.vue";
import GitHubRawData from "@components/content-blocks/GitHubRawData.astro";
import CodeHighlighting from "@components/content-blocks/CodeHighlighting.astro";
import { Code } from "astro/components";
import { parse } from "@utils/helpers";
import he from "he";

import type { InferGetStaticParamsType, InferGetStaticPropsType } from "astro";

export const getStaticPaths = async () => {
  const postWithSlugsDe = await getAllPostsWithSlugs();
  const postWithSlugsEn = await getAllPostsWithSlugs("EN");

  const postWithSlugsAllLang = [...postWithSlugsDe.edges, ...postWithSlugsEn.edges];

  return postWithSlugsAllLang.map(({ node }) => {
    return {
      params: {
        postSlug: node.slug,
        lang: node?.language?.slug,
      },
    };
  });
};

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { postSlug, lang } = Astro.params as Params;
const post = await getPostBySlug(postSlug!, 90);

const findLanguage = (content: string, prefix = "lang-"): string | null => {
  const regex = new RegExp(prefix + "[a-z]+", "gm");
  const match = content.match(regex)?.toString().replace(prefix, "") as string | null;
  return match;
};

const headings = post?.blocks?.filter(
  (block: CoreHeadingBlock) =>
    block.name === "core/heading" &&
    (JSON.parse(block.attributesJSON as string).level === 2 ||
      JSON.parse(block.attributesJSON as string).level === 3),
) as CoreHeadingBlock[];
---

<BlogPost content={post} headings={headings}>
  {
    post?.blocks?.map((block) => {
      // return <pre>{block.name}</pre>;
      if (block.name === "core/paragraph") {
        return <ParagraphBlock block={block} />;
      }
      if (block.name === "core/heading") {
        return <HeadlineBlock block={block} />;
      }
      if (block.name === "core/image") {
        return <FigureBlock block={block} />;
      }
      if (block.name === "core/buttons") {
        return <ButtonsBlock block={block} client:only="vue" />;
      }
      if (block.name === "core/list") {
        return <ListBlock block={block} />;
      }
      if (block.name === "core/details") {
        return <DetailsBlock block={block} />;
        return <pre>{block}</pre>;
      }
      if (block.name === "acf/github-raw-data") {
        return <GitHubRawData block={block} />;
      }
      if (block.name === "acf/code-highlighting") {
        return <CodeHighlighting block={block} />;
      }
      if (block.name === "core/code") {
        return (
          <div class="c-blocks__code">
            <Code
              code={he.decode(parse(block.attributesJSON).content)}
              lang={parse(block.attributesJSON).className}
              theme="css-variables"
            />
          </div>
        );
      } else {
        return <Fragment set:html={block.originalContent} />;
      }
    })
  }
</BlogPost>
